<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<title>OPC UA with IEC 61499 Tutorial</title>
	<link rel="stylesheet" type="text/css" href="../help.css">
</head>
<body>
<h1>OPC UA with IEC 61499 Tutorial</h1>
<p>This tutorial shows you how you can use <a href="https://en.wikipedia.org/wiki/OPC_Unified_Architecture" target="_blank">OPC UA</a> in an IEC 61499
	<em>Application</em> using available FBs. You should first complete the <a href="../tutorials/flipFlop_tutorial.html">Flip-Flop Tutorial</a> to get familiar
	with the 4diac IDE.<br/>
	FORTE uses the <a href="http://open62541.org/" target="_blank">opne62541</a> OPC UA stack which is open source and can also be used in commercial
	projects free of charge.
</p>

Tasks in this tutorial:
<ol>
	<li>Build FORTE with open62541</li>
	<li>Provide OPC UA variables to clients</li>
	<li>Offer an OPC UA method to be called by clients</li>
</ol>

Prerequisites:
<ul>
	<li>4DIAC-IDE</li>
</ul>


<a name="build"/></a>
<h2>Build FORTE with open62541</h2>
<p>OPC UA is not enabled by default in FORTE. To enable it, you need to build FORTE with the open62541 source code yourself.</p>

<ol>
	<li>Download the FORTE source from <a href="http://git.eclipse.org/c/4diac/org.eclipse.4diac.forte.git" target="_blank">http://git.eclipse.org/c/4diac/org.eclipse.4diac.forte.git</a>:
		<pre>
			mkdir ~/4diac && cd "$_"
			git clone https://git.eclipse.org/r/4diac/org.eclipse.4diac.forte forte
			# as of now you need to use the develop branch
			cd forte && git checkout develop
			mkdir build && cd $_
			cmake ..
		</pre>
	</li>
	<li>Download the source for open62541 from <a href="https://github.com/open62541/open62541"
												  target="_blank">https://github.com/open62541/open62541</a>:
		<pre>
			cd ~/4diac
			git clone https://github.com/open62541/open62541.git open62541
		</pre>
	</li>
	<li>Build open62541. If you are running the code on production devices we suggesst setting the build type to <em>Release</em>.
		<pre>
			cd ~/4diac/open62541 && mkdir build && cd $_
			cmake -DBUILD_SHARED_LIBS=ON -DCMAKE_BUILD_TYPE=Debug -DUA_ENABLE_AMALGAMATION=ON ..
			make -j
		</pre>
	</li>
	<li>Set FORTE to include open62541. If you are running the code on production devices we suggesst setting the build type to <em>Release</em>.
		<pre>
			cd ~/4diac/forte/build
			cmake -DCMAKE_BUILD_TYPE=Debug -DFORTE_ARCHITECTURE=Posix -DFORTE_COM_OPC_UA=ON -DFORTE_COM_OPC_UA_DIR=$HOME/4diac/open62541/build ..
			make -j
		</pre>
	</li>
</ol>

<a name="variables"/></a>
<h2>OPC UA variables</h2>

<a name="variables_flipFlop"/></a>
<h3>Flip-Flop Application using Variables</h3>

<p>In this step you will create a simple Flip-Flop <em>Application</em> which uses <em>Publisher</em> and <em>Subscriber</em> function blocks to
	create
	<em>Variables</em> in the address space of the OPC UA Server. Clients can then read from those variables or write new values.</p>
<p>
	Follow the steps in the <a href="../tutorials/flipFlop_tutorial.html">Flip-Flop Tutorial</a> to create a new <em>System</em>, <em>Application</em>, and <em>Device</em>.<br/>
	When you have created the empty Application, continue with the following steps.
</p>

<p>
	In the following steps we create a flip flop application where a boolean value is read from an OPC UA Variable and then its negated value
	published as another variable. To achieve this, we make use of <em>SUBSCRIBE</em> and <em>PUBLISH</em> function blocks. The <em>SUBSCRIBE</em>
	function block is used for subscribing to one or multiple OPC UA Variables, i.e., the value of the variable will be available in the Application.
	The <em>PUBLISH</em> function block is used to publish a value from within the Application so that it can be read by clients.<br/>
	When the <em>INIT</em> event of those function blocks is triggered, the OPC UA server is initialized and started on the default endpoint url:
	<strong>opc.tcp://localhost:4840</strong>. Note that only one OPC UA server will be created and the address model is shared between all the
	function blocks.
</p>

<ol>
	<li>Drag the following function blocks from the Type Library into the Application Editor:
		<ul>
			<li>events/E_SWITCH</li>
			<li>events/E_SR</li>
			<li>net/SUBSCRIBE_1</li>
			<li>net/PUBLISH_1</li>
		</ul>
	</li>
	<li>Connect the function blocks in the following way:<br/>
		<img src="./img/opc_ua_flipFlop_FB.png" alt="OPC UA Flip-Flop Application"/>
	</li>
	<li>Map the function blocks to the device</li>
	<li>Rename the <em>E_SWITCH</em> and <em>E_SR</em> function blocks, e.g. to <tt>Flipper</tt> and <tt>Flopper</tt></li>
	<li>To configure where the variable nodes are created in the address space, you can use the <em>ID</em> fields of the <em>SUBSCRIBE</em>/<em>PUBLISH</em>
		function blocks. We want to create the variables under <tt>/Objects/FlipFlop</tt> , whereas the node <tt>FlipFlop</tt> should be created in
		namespace 1. Therefore we set the <em>ID</em> to <strong>opc_ua[/Objects/1:FlipFlop]</strong>. If you don't indicate the namespace explicitly
		(the <tt>1:</tt>), then it will take the namespace <tt>1</tt> as default. <em>QI</em> has to be set to 1 to enable the function block.
	</li>
	<li>Open the <em>System</em> Editor and connect the <em>COLD</em> and <em>WARM</em> ports to the two <em>INIT</em> ports. So finally it should
		look like this:<br/>
		<img src="./img/opc_ua_flipFlop_FB_full.png" alt="OPC UA Flip-Flop Application connected"/>
	</li>
	<li>Deploy the Application to FORTE</li>
	<li>Open UaExpert (you can get it from <a href="https://www.unified-automation.com/de/downloads/opc-ua-clients.html">here</a>) and connect to the
		OPC UA server running on FORTE: <strong>opc.tcp://localhost:4840</strong>
	</li>
	<li>You should see the two variables which have been created by the <em>SUBSCRIBE</em> and <em>PUBLISH</em> function blocks:<br/>
		<img src="./img/opc_ua_flipFlop_uaExpert.png" alt="OPC UA Flip-Flop in UaExpert"/><br/>
		As you can see, below <tt>Objects</tt> there's a <tt>FolderObjectNode</tt> with the name <tt>FlipFlop</tt>. This name comes from the
		<em>ID</em> configuration of the function block.<br/>
		The two <tt>ObjectNode</tt>s <tt>Flipper</tt> and <tt>Flopper</tt> are created out of the connection of the function blocks: The
		<em>SUBSCRIBE</em> FB is connected through <em>RD_1</em> with the <em>G</em> port of the <em>Flipper</em> FB. Therefore there's a <tt>VariableNode</tt>
		called <tt>G</tt> in <tt>Flipper</tt> ObjectNode. The same was created for the <em>PUBLISH</em> FB. The data type of the variables is derived
		from the FB's port datatype.<br/>
		Note: You can change the name of the <tt>ObjectNode</tt> (i.e., Flipper, Flopper) by renaming the function blocks. Currently it is not
		possible to change the names of the <tt>VariableNode</tt>s. They will always have the name of the port.
	</li>
	<li>Optionally you can now monitor the Application in FORTE, e.g., watch the values of <em>SUBSCRIBE</em> and <em>PUBLISH</em> FB. See <a
			href="../tutorials/flipFlop_tutorial.html#monitor">Flip-Flop Tutorial - Monitor</a> on how to do that.
	</li>
	<li>In UaExpert drag the two variables <tt>G</tt> and <tt>Q</tt> into the <em>Data Access View</em>. Here you can now change the value of
		<tt>G</tt>. This will cause the <em>IND</em> port of <em>SUBSCRIBE</em> to fire an event and FORTE will read the new variable value, negate it
		and set <tt>Q</tt> to the negated value. The <em>REQ</em> event of the <em>PUBLISH</em> FB has to be triggered to set the new value from <em>SD_1</em>
		in the address model of OPC UA.<br/>
		Note that in the beginning both values will be <tt>false</tt> since no event has been triggered yet.
	</li>
	<li>In FORTE check the monitored application to see what happens there if you change a variable.</li>
</ol>

<a name="variables_adder"/></a>
<h3>Adder Application using Variables</h3>

<p>
	Here you can see another example how to use <em>SUBSCRIBE</em> and <em>PUBLISH</em> to create an IEC 61499 application which adds two values, by
	reading the values from an OPC UA variable and providing the result.</p>
<p>
	If you followed the steps before you should be able to create a new Application which looks like this:<br/>
	<img src="./img/opc_ua_adder_full.png" alt="OPC UA Adder Application"/><br/>

	The <em>F_ADD</em> function block is a generic type which can have any supported data type for the <em>IN1</em>, <em>IN2</em> and <em>OUT</em>
	ports. On the other hand the <em>SUBSCRIBE</em> and <em>PUBLISH</em> FBs need to now which datatype the created variables should have. To
	introduce this information into the application model, you can use the <em>INT2INT</em> converter function block.<br/><br/>

	This will create the following nodes in the OPC UA Server:<br/>
	<img src="./img/opc_ua_adder_uaExpert.png" alt="OPC UA Adder in UA Expert"/><br/>
	Try to understand from where the names for <tt>Num1</tt>, <tt>Num2</tt>, and <tt>Result</tt> come from.<br/><br/>

	You can then drag the variables into UaExpert's Data Access View and change the value of <tt>Num1/IN</tt> and <tt>Num2/IN</tt>. The value of <tt>Result/OUT</tt>
	should then be the sum of those two values.

</p>


<a name="methods"/></a>
<h2>OPC UA Methods</h2>

<p>
	In this step you will see how you can create OPC UA methods in an IEC 61499 application. It uses the <em>SERVER</em> function block which creates
	the corresponding OPC UA method automatically in the address model.
</p>
<p>
	Follow the steps in the <a href="../tutorials/flipFlop_tutorial.html">Flip-Flop Tutorial</a> to create a new <em>System</em>, <em>Application</em>, and <em>Device</em>.<br/>
	When you have created the empty Application, continue with the following steps.
</p>

<ol>
	<li>Drag the following function blocks from the Type Library into the Application Editor:
		<ul>
			<li>3x convert/INT2INT</li>
			<li>IEC61131-3/Arithmetic/F_ADD</li>
			<li>net/SERVER_1_2</li>
		</ul>
	</li>
	<li>Map the function blocks to the device</li>
	<li>Connect the function blocks and rename them in the following way:<br/>
		<img src="./img/opc_ua_method_full.png" alt="OPC UA Method Application"/>
	</li>
	<li>The name of the <em>SERVER</em> FB is at the same time the name of the Method which will be created in the OPC UA Server. The <em>RD</em>
		ports of the <em>SERVER</em> are the method's input arguments, the <em>SD</em> ports the output arguments.
	</li>
	<li>Deploy the Application to FORTE</li>
	<li>Open UaExpert and you should see the following address model:<br/>
		<img src="./img/opc_ua_method_uaExpert.png" alt="OPC UA Method in UaExpert"/>
	</li>
	<li>Optionally you can again monitor the application in 4diac</li>
	<li>In UaExpert Right-Click on the Method Node <tt>AddValues</tt> and select <em>Call..</em>. You will be presented with the following
		window:<br/>
		<img src="./img/opc_ua_method_call.png" alt="OPC UA Method Call"/>
	</li>
	<li>You can see that the name of the input and output arguments are the names of the connected function blocks. Enter values for <tt>Num1</tt> and
		<tt>Num2</tt> and press <em>Call</em>. FORTE will trigger the <em>IND</em> event of the <em>SERVER</em> FB, which causes the <em>F_ADD</em> FB
		to calculate the sum of the two numbers. When the sum is ready, the <em>RSP</em> event on <em>SERVER</em> is triggered and the result is
		returned to the calling OPC UA Client, which is in this case UaExpert.<br/>
		<strong>Note:</strong> After the <em>IND</em> event is triggered, the result has to be ready (i.e., the <em>RSP</em> event has to be
		triggered) within 4 seconds. This is the default timeout for a method call. Otherwise the call will fail with a timeout error code.
	</li>
</ol>

</body>
</html>